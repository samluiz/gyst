name: CI/CD Quality Gate

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  GRADLE_OPTS: "-Djava.net.preferIPv4Stack=true"

jobs:
  android_shared_quality:
    name: Android + Shared Lint and Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Inject google-services.json
        shell: bash
        env:
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_B64" ]; then
            echo "Missing required secret: GOOGLE_SERVICES_JSON_B64"
            exit 1
          fi
          echo "$GOOGLE_SERVICES_JSON_B64" | base64 --decode > androidApp/google-services.json

      - name: Run lint and tests
        run: |
          chmod +x gradlew
          for attempt in 1 2 3; do
            ./gradlew \
              :shared:compileKotlinDesktop \
              :shared:desktopTest \
              :androidApp:lintDebug \
              :androidApp:testDebugUnitTest \
              --no-daemon && break
            if [ "$attempt" -eq 3 ]; then
              echo "Gradle quality gate failed after 3 attempts."
              exit 1
            fi
            echo "Attempt $attempt failed. Retrying in 20s..."
            sleep 20
          done

  desktop_windows_quality:
    name: Desktop Windows Validation
    runs-on: windows-latest
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Run desktop tests
        shell: pwsh
        run: |
          $attempt = 0
          do {
            $attempt++
            .\gradlew :desktopApp:desktopTest :shared:desktopTest --no-daemon
            if ($LASTEXITCODE -eq 0) { break }
            if ($attempt -ge 3) { throw "Desktop validation failed after 3 attempts." }
            Start-Sleep -Seconds 20
          } while ($true)

  desktop_linux_quality:
    name: Desktop Linux Validation
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Run desktop tests
        run: |
          chmod +x gradlew
          for attempt in 1 2 3; do
            ./gradlew :desktopApp:desktopTest :shared:desktopTest --no-daemon && break
            if [ "$attempt" -eq 3 ]; then
              echo "Desktop Linux validation failed after 3 attempts."
              exit 1
            fi
            echo "Attempt $attempt failed. Retrying in 20s..."
            sleep 20
          done

  desktop_macos_quality:
    name: Desktop macOS Validation
    runs-on: macos-14
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Run desktop tests
        run: |
          chmod +x gradlew
          for attempt in 1 2 3; do
            ./gradlew :desktopApp:desktopTest :shared:desktopTest --no-daemon && break
            if [ "$attempt" -eq 3 ]; then
              echo "Desktop macOS validation failed after 3 attempts."
              exit 1
            fi
            echo "Attempt $attempt failed. Retrying in 20s..."
            sleep 20
          done

  ios_compile_quality:
    name: iOS Shared Compile Validation
    runs-on: macos-14
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Validate iOS shared compilation
        run: |
          chmod +x gradlew
          for attempt in 1 2 3; do
            ./gradlew :shared:compileKotlinIosSimulatorArm64 --no-daemon && break
            if [ "$attempt" -eq 3 ]; then
              echo "iOS compile validation failed after 3 attempts."
              exit 1
            fi
            echo "Attempt $attempt failed. Retrying in 20s..."
            sleep 20
          done

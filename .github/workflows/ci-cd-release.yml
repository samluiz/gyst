name: CI/CD Release

on:
  workflow_dispatch:
    inputs:
      skip_quality_gate:
        description: "Skip quality gates"
        required: true
        default: false
        type: boolean
      build_ios:
        description: "Build iOS IPA"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  validate_release_ref:
    name: Validate Release Ref
    runs-on: ubuntu-latest
    steps:
      - name: Ensure workflow runs from a tag
        run: |
          if [[ "${GITHUB_REF}" != refs/tags/* ]]; then
            echo "This workflow must be dispatched from a tag in 'Use workflow from'."
            echo "Current ref: ${GITHUB_REF}"
            exit 1
          fi
          echo "Release ref OK: ${GITHUB_REF}"

  quality_gate_android:
    name: Quality Gate (Android)
    if: ${{ github.event.inputs.skip_quality_gate != 'true' }}
    runs-on: ubuntu-latest
    needs: [validate_release_ref]
    timeout-minutes: 45
    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Validate wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Inject google-services.json
        shell: bash
        env:
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_B64" ]; then
            echo "Missing required secret: GOOGLE_SERVICES_JSON_B64"
            exit 1
          fi
          echo "$GOOGLE_SERVICES_JSON_B64" | base64 --decode > androidApp/google-services.json

      - name: Run quality checks
        run: |
          chmod +x gradlew
          ./gradlew \
            :shared:compileKotlinDesktop \
            :shared:desktopTest \
            :androidApp:lintDebug \
            :androidApp:testDebugUnitTest \
            --no-daemon

  quality_gate_windows:
    name: Quality Gate (Windows/Desktop)
    if: ${{ github.event.inputs.skip_quality_gate != 'true' }}
    runs-on: windows-latest
    needs: [validate_release_ref]
    timeout-minutes: 45
    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Run quality checks
        shell: pwsh
        run: |
          .\gradlew :desktopApp:desktopTest :shared:desktopTest --no-daemon

  quality_gate_ios:
    name: Quality Gate (iOS)
    if: ${{ github.event.inputs.build_ios == 'true' && github.event.inputs.skip_quality_gate != 'true' }}
    runs-on: macos-14
    needs: [validate_release_ref]
    timeout-minutes: 45
    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Run iOS quality checks
        run: |
          chmod +x gradlew
          ./gradlew :shared:compileKotlinIosSimulatorArm64 --no-daemon

  build_release_android:
    name: Build Android Release APK
    runs-on: ubuntu-latest
    needs: [validate_release_ref, quality_gate_android, quality_gate_windows]
    if: ${{ always() && needs.validate_release_ref.result == 'success' && (github.event.inputs.skip_quality_gate == 'true' || (needs.quality_gate_android.result == 'success' && needs.quality_gate_windows.result == 'success')) }}
    env:
      APP_VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Inject google-services.json
        shell: bash
        env:
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_B64" ]; then
            echo "Missing required secret: GOOGLE_SERVICES_JSON_B64"
            exit 1
          fi
          echo "$GOOGLE_SERVICES_JSON_B64" | base64 --decode > androidApp/google-services.json

      - name: Decode release keystore (if provided)
        shell: bash
        env:
          GYST_KEYSTORE_B64: ${{ secrets.GYST_KEYSTORE_B64 }}
        run: |
          if [ -n "$GYST_KEYSTORE_B64" ]; then
            echo "$GYST_KEYSTORE_B64" | base64 --decode > "$RUNNER_TEMP/gyst-release.jks"
          else
            echo "No keystore secret provided. Building unsigned release artifact."
          fi

      - name: Build release APK
        env:
          GYST_KEYSTORE_PASSWORD: ${{ secrets.GYST_KEYSTORE_PASSWORD }}
          GYST_KEY_ALIAS: ${{ secrets.GYST_KEY_ALIAS }}
          GYST_KEY_PASSWORD: ${{ secrets.GYST_KEY_PASSWORD }}
          GYST_KEYSTORE_PATH_DEFAULT: ${{ runner.temp }}/gyst-release.jks
        run: |
          chmod +x gradlew
          if [ -f "$GYST_KEYSTORE_PATH_DEFAULT" ]; then
            export GYST_KEYSTORE_PATH="$GYST_KEYSTORE_PATH_DEFAULT"
          else
            unset GYST_KEYSTORE_PATH
            unset GYST_KEYSTORE_PASSWORD
            unset GYST_KEY_ALIAS
            unset GYST_KEY_PASSWORD
          fi
          ./gradlew :androidApp:assembleRelease -Papp.version=$APP_VERSION --no-daemon

      - name: Normalize Android artifact name
        shell: bash
        run: |
          VERSION_LABEL="${APP_VERSION#v}"
          mkdir -p release-dist
          APK_PATH="$(ls -1 androidApp/build/outputs/apk/release/*.apk | head -n 1)"
          if [ -z "$APK_PATH" ]; then
            echo "No APK produced."
            exit 1
          fi
          cp "$APK_PATH" "release-dist/gyst-${VERSION_LABEL}.apk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: release-dist/gyst-*.apk
          if-no-files-found: error

  build_release_windows:
    name: Build Windows MSI and Portable
    runs-on: windows-latest
    needs: [validate_release_ref, quality_gate_android, quality_gate_windows]
    if: ${{ always() && needs.validate_release_ref.result == 'success' && (github.event.inputs.skip_quality_gate == 'true' || (needs.quality_gate_android.result == 'success' && needs.quality_gate_windows.result == 'success')) }}
    env:
      APP_VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Inject desktop OAuth client JSON
        shell: pwsh
        env:
          GYST_DESKTOP_OAUTH_JSON_B64: ${{ secrets.GYST_DESKTOP_OAUTH_JSON_B64 }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:GYST_DESKTOP_OAUTH_JSON_B64)) {
            throw "Missing required secret: GYST_DESKTOP_OAUTH_JSON_B64"
          }
          New-Item -ItemType Directory -Force -Path "desktopApp\src\desktopMain\resources" | Out-Null
          [IO.File]::WriteAllBytes(
            "desktopApp\src\desktopMain\resources\desktop_oauth_client.json",
            [Convert]::FromBase64String($env:GYST_DESKTOP_OAUTH_JSON_B64)
          )

      - name: Build MSI and distributable
        shell: pwsh
        run: |
          .\gradlew :desktopApp:packageReleaseMsi :desktopApp:createDistributable "-Papp.version=$env:APP_VERSION" --no-daemon

      - name: Zip portable Windows app
        shell: pwsh
        run: |
          $version = $env:APP_VERSION.TrimStart("v")
          New-Item -ItemType Directory -Path "release-dist" -Force | Out-Null
          $source = "desktopApp\build\compose\binaries\main\app"
          if (-not (Test-Path $source)) { $source = "desktopApp\build\compose\binaries\main-release\app" }
          if (-not (Test-Path $source)) { throw "Desktop distributable folder not found." }
          Compress-Archive -Path "$source\*" -DestinationPath "release-dist\gyst-$version-windows-portable.zip" -Force

          $msi = Get-ChildItem "desktopApp\build\compose\binaries" -Recurse -Filter *.msi | Select-Object -First 1
          if (-not $msi) { throw "MSI artifact not found." }
          Copy-Item $msi.FullName "release-dist\gyst-$version.msi" -Force

          $exe = Get-ChildItem $source -Recurse -Filter *.exe | Where-Object { $_.Name -notmatch "unins|setup" } | Select-Object -First 1
          if ($exe) {
            Copy-Item $exe.FullName "release-dist\gyst-$version.exe" -Force
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-desktop
          path: release-dist/*
          if-no-files-found: error

  build_release_ios:
    name: Build iOS IPA
    if: ${{ github.event.inputs.build_ios == 'true' && (github.event.inputs.skip_quality_gate == 'true' || needs.quality_gate_ios.result == 'success') }}
    runs-on: macos-14
    needs: [validate_release_ref, quality_gate_ios]
    env:
      APP_VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout selected tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Validate iOS release secrets
        env:
          IOS_CERTIFICATE_P12_B64: ${{ secrets.IOS_CERTIFICATE_P12_B64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_B64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_EXPORT_OPTIONS_PLIST_B64: ${{ secrets.IOS_EXPORT_OPTIONS_PLIST_B64 }}
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          for name in IOS_CERTIFICATE_P12_B64 IOS_CERTIFICATE_PASSWORD IOS_PROVISIONING_PROFILE_B64 IOS_KEYCHAIN_PASSWORD IOS_EXPORT_OPTIONS_PLIST_B64 IOS_TEAM_ID; do
            if [ -z "${!name}" ]; then
              echo "Missing required secret: $name"
              exit 1
            fi
          done

      - name: Prepare iOS signing assets
        env:
          IOS_CERTIFICATE_P12_B64: ${{ secrets.IOS_CERTIFICATE_P12_B64 }}
          IOS_PROVISIONING_PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_B64 }}
          IOS_EXPORT_OPTIONS_PLIST_B64: ${{ secrets.IOS_EXPORT_OPTIONS_PLIST_B64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          mkdir -p "$RUNNER_TEMP/ios-signing"
          echo "$IOS_CERTIFICATE_P12_B64" | base64 --decode > "$RUNNER_TEMP/ios-signing/cert.p12"
          echo "$IOS_PROVISIONING_PROFILE_B64" | base64 --decode > "$RUNNER_TEMP/ios-signing/profile.mobileprovision"
          echo "$IOS_EXPORT_OPTIONS_PLIST_B64" | base64 --decode > "$RUNNER_TEMP/ios-signing/ExportOptions.plist"

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security import "$RUNNER_TEMP/ios-signing/cert.p12" -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$IOS_KEYCHAIN_PASSWORD" build.keychain

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$RUNNER_TEMP/ios-signing/profile.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/"

      - name: Build and archive iOS app
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_IDENTIFIER: ${{ secrets.IOS_BUNDLE_IDENTIFIER }}
        run: |
          VERSION_NAME="${APP_VERSION#v}"
          BUILD_NUMBER="$(echo "$VERSION_NAME" | awk -F. '{printf "%d%02d%02d\n",$1,$2,$3}')"
          BUNDLE_ID="${IOS_BUNDLE_IDENTIFIER:-com.samluiz.gyst}"
          xcodebuild \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$RUNNER_TEMP/Gyst.xcarchive" \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            MARKETING_VERSION="$VERSION_NAME" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            clean archive

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/Gyst.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ios-signing/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/ios-export"

      - name: Normalize iOS artifact name
        run: |
          VERSION_LABEL="${APP_VERSION#v}"
          mkdir -p release-dist
          IPA_PATH="$(find "$RUNNER_TEMP/ios-export" -name '*.ipa' | head -n 1)"
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA produced."
            exit 1
          fi
          cp "$IPA_PATH" "release-dist/gyst-${VERSION_LABEL}.ipa"

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: release-dist/gyst-*.ipa
          if-no-files-found: error

  publish_github_release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [validate_release_ref, build_release_android, build_release_windows, build_release_ios]
    if: ${{ always() && needs.validate_release_ref.result == 'success' && needs.build_release_android.result == 'success' && needs.build_release_windows.result == 'success' && (github.event.inputs.build_ios != 'true' || needs.build_release_ios.result == 'success') }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release-assets/**/*.apk
            release-assets/**/*.msi
            release-assets/**/*.exe
            release-assets/**/*.zip
            release-assets/**/*.ipa
